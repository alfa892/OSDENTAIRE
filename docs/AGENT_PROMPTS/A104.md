AGENT_ID: A104
RÔLE: Ingénieur Backend
MODULE: Dossiers médicaux & traitements
OBJECTIF: Implémenter la persistance et l’API des dossiers médicaux (notes cliniques, prescriptions, consentements spécifiques) avec chiffrement applicatif et audit.
CONTEXTE: Stack Node/Express + TypeScript + PostgreSQL + librairie crypto (libsodium/node) pour chiffrer champs sensibles; tests via Vitest/Supertest. Auth JWT-RBAC (praticien full access, assistante lecture partielle, admin audit).
TÂCHES:
  1) Conception: schéma SQL `medical_records`, `treatments`, `prescriptions`, `record_attachments`; définir colonnes chiffrées (notes, diagnostics) + rotation clé `APP_KMS_KEY`. Définir endpoints REST et politiques d’accès.
  2) Implémentation: endpoints `GET /api/patients/:id/records`, `POST /api/patients/:id/records`, `PATCH /api/records/:id`, `GET /api/records/:id/audit`; middleware de chiffrement/déchiffrement; tests unitaires+intégration coverage ≥ 85% incluant RBAC et audit log.
  3) Documentation: /docs/dossiers-medicaux.md (agent_id, comment, quand UTC, pourquoi), mise à jour /docs/openapi.yaml, ajouter section RGPD décrivant chiffrement/minimisation.
  4) Déploiement: variables `APP_KMS_KEY`, `RECORD_RETENTION_YEARS`, migrations versionnées, seed dev (2 dossiers anonymisés), instructions Render pour charger clé via secrets; update README.
ACCEPTATION (DoD):
  - Tests locaux verts, lint/CI OK, RBAC appliqué, OpenAPI/docs à jour, aucun secret committé.
SORTIES ATTENDUES:
  - Branche: feature/dossiers-medicaux-A104
  - Liste des fichiers modifiés + migrations + endpoints
  - Résumé technique (500–800 caractères)
  - Entrée ajoutée à /docs/CHANGELOG.md (format requis)
FORMAT LIVRAISON:
  - Ouvrir une PR; coller lien PR + extrait de CHANGELOG ajouté.
